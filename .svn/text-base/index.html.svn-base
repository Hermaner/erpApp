<!DOCTYPE html>
<html class="mui-index-htmlcolor">

	<head>
		<meta charset="utf-8">
		<title>首页</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.css">
		<link rel="stylesheet" href="css/iconfont.css">
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/stylebypad.css">
		<script src="js/apijs/api.js"></script>
		<script src="js/mui.min.js"></script>
	</head>

	<body class="mui-index-bodycolor">
		<nav class="mui-bar mui-bar-tab mui-indxe-navfontcolor">
			<a id="defaultTab" class="mui-tab-item mui-active" href="home2.html">
				<span class="mui-icon mui-icon-home"></span>
				<span class="mui-tab-label">首页</span>
			</a>
			<a class="mui-tab-item" href="item/items.html">
				<span class="mui-icon iconfont icon-mendianchaxun"></span>
				<span class="mui-tab-label">商品</span>
			</a>
			<a class="mui-tab-item" href="list/dingdan.html">
				<span class="mui-icon iconfont icon-order" id="addRed">
					<!--<span class="mui-badge dd-changebad">&nbsp;</span>-->
				</span>
				<span class="mui-tab-label">订单</span>
			</a>
			<a class="mui-tab-item" href="more/more.html">
				<span class="mui-icon iconfont icon-gengduo"></span>
				<span class="mui-tab-label">更多</span>
			</a>
		</nav>
		<script type="text/javascript" charset="utf-8">
			//mui初始化
			var itemPage, homePage, orderPage, pushsetPage;
			mui.init({
				preloadPages: [{
					"id": "list/listdetail.html",
					"url": "list/listdetail.html",
				}, {
					"id": 'map/maps_map.html',
					"url": 'map/maps_map.html'
				}, {
					"id": "calldetail.html",
					"url": "list/calldetail.html",
				}, {
					"id": "choose.html",
					"url": "list/choose.html",
				}, {
					"id": "pushset.html",
					"url": "more/tongzhituisong.html",
				}, {
					"id": "listdetailbyshop.html",
					"url": "list/listdetailbyshop.html",
				}]
			});
			var subpages = ['home2.html', 'item/items.html', 'list/dingdan.html', 'more/more.html'];
			var subpage_style, self;
			subpage_style = {
				top: '0px',
				bottom: '50px'
			};
			var aniShow = {};
			//创建子页面，首个选项卡页面显示，其它均隐藏；
			mui.plusReady(function() {
				plus.key.addEventListener('backbutton', function() {
					if (confirm('确定退出吗？')) {
						plus.runtime.quit();
					}
				}, false);
				self = plus.webview.currentWebview();
				var initView = plus.webview.create('login.html', 'login.html', {
					top: '0px',
					bottom: '0px'
				});
				self.append(initView);
				for (var i = 0; i < 4; i++) {
					var temp = {};
					var sub = plus.webview.create(subpages[i], subpages[i], subpage_style);
					sub.hide();
					self.append(sub);
				}
				plus.push.addEventListener("click", function(msg) {
					var payload = msg.payload;
					if (payload.payload) {
						return
					}
					var confirmArray = ['确定', '取消'];
					mui.confirm('有新订单，是否立即跳转？', '', confirmArray, function(e) {
						if (e.index == 0) {
							checkDetail(payload)
						}
					})
				}, false);
				plus.push.addEventListener("receive", function(msg) {
					var payload = msg.payload;
					if (payload.payload) {
						return
					}
					var confirmArray = ['确定', '取消'];
					mui.confirm('有新订单，是否立即跳转？', '', confirmArray, function(e) {
						if (e.index == 0) {
							checkDetail(payload)
						}
					})
				}, false);
				plus.storage.setItem("itemExist", "0")
				document.addEventListener("resume", function() { //程序后台切换到前台时调用
					outLine();
					plus.runtime.setBadgeNumber(0);
				}, false);
			});

			function loadChild() { //跨页面调用js方法
				itemPage = plus.webview.getWebviewById('item/items.html')
				homePage = plus.webview.getWebviewById('home2.html')
				orderPage = plus.webview.getWebviewById('list/dingdan.html')
				pushsetPage = plus.webview.getWebviewById('pushset.html')
				pushsetPage = plus.webview.getWebviewById('pushset.html')
				homePage.evalJS("loadData()")
				pushsetPage.evalJS("loadData()")
				plus.runtime.setBadgeNumber(0);
			}

			function outLine() { //程序后台切换到前台时调用相对页面的刷新方法
				var tab = document.getElementsByClassName("mui-active")[0].getAttribute('href');
				homePage = plus.webview.getWebviewById('home2.html')
				if (tab == "home2.html") {
					homePage.evalJS("loadData()")
				} else if (tab == "item/items.html") {
					itemPage.evalJS("getThisDate('',1)")
				} else if (tab == "list/dingdan.html") {
					orderPage.evalJS("getThisDate('','',1)")
				}
			}
			//当前激活选项
			var activeTab = subpages[0];
			//var title = document.getElementById("title");
			//选项卡点击事件
			mui('.mui-bar-tab').on('tap', 'a', function(e) {
				var targetTab = this.getAttribute('href');
				if (targetTab == activeTab) {
					return;
				}
				plus.nativeUI.showWaiting()
				if (targetTab == "home2.html") {
					homePage.evalJS("loadData()")
				} else if (targetTab == "item/items.html") {
					itemPage.evalJS("getThisDate('',1)")
					homePage.evalJS("changeActive()")
				} else if (targetTab == "list/dingdan.html") {
					orderPage.evalJS("getThisDate('','',1)")
					homePage.evalJS("changeActive()")
				} else {
					plus.nativeUI.closeWaiting();
					homePage.evalJS("changeActive()")
				}
				if (mui.os.ios || aniShow[targetTab]) {
					plus.webview.show(targetTab);
				} else {
					plus.webview.show(targetTab, "fade-in", 300);
				}
				//隐藏当前;
				plus.webview.hide(activeTab);
				//更改当前活跃的选项卡
				activeTab = targetTab;
			});

			function orderlistback(uid) { //点击选项卡跨页面刷新订单列表信息
				plus.nativeUI.showWaiting()
				var listPage = plus.webview.getWebviewById("list/dingdan.html");
				var nav_a0 = document.getElementsByClassName("mui-indxe-navfontcolor")[0].getElementsByTagName("a")[0];
				var nav_a2 = document.getElementsByClassName("mui-indxe-navfontcolor")[0].getElementsByTagName("a")[2];
				listPage.evalJS("getThisDate('" + uid + "',0,1)")
				nav_a0.setAttribute("class", "mui-tab-item");
				nav_a2.setAttribute("class", "mui-tab-item mui-active");
				activeTab = subpages[2];
			}

			function moreback() { //more页面点击退出登录后更换home选项卡
				var nav_a3 = document.getElementsByClassName("mui-indxe-navfontcolor")[0].getElementsByTagName("a")[3];
				var nav_a0 = document.getElementsByClassName("mui-indxe-navfontcolor")[0].getElementsByTagName("a")[0];
				nav_a3.setAttribute("class", "mui-tab-item");
				nav_a0.setAttribute("class", "mui-tab-item mui-active");
				activeTab = subpages[0];
			}

			function checkDetail(e) { //订单列表查询接口，接口文档No.12
				var pageDetail = plus.webview.getWebviewById("list/listdetail.html")
				var param = systemParam("V5.mobile.order.info.get");
				param.orderNumber = e;
				plus.nativeUI.showWaiting()
				dataSendFn('orderInfoGet', param, function(data) {
					if (!data.isSuccess) {
						var mapmsg = data.map.errorMsg;
						plus.nativeUI.alert(mapmsg, function() {}, "", "OK");
						console.log(mapmsg)
						return
					}
					alert(1)
					data = JSON.stringify(data)
					mui.openWindow({
						id: "list/listdetail.html",
						show: {
							aniShow: "pop-in"
						},
						waiting: {
							autoShow: false
						}
					})
					pageDetail.evalJS("loadData('" + data + "',1)");
				}, "get")
			}

			function addRed(e) {
				var addRed = document.getElementById("addRed");
				if (e == 1) {
					var html = '<span class="mui-badge dd-changebad">&nbsp;</span>';
					var span = document.createElement("span");
					span.innerHTML = html;
					addRed.appendChild(span);
				} else {
					addRed.innerHTML = "";
				}
			}
		</script>
	</body>

</html>